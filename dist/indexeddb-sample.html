<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB サンプル</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1>IndexedDB サンプルアプリケーション</h1>
    
    <div class="container">
        <h2>データベース操作</h2>
        <button onclick="initDB()">データベース初期化</button>
        <button onclick="generateSampleData()">サンプルデータ生成</button>
        <button onclick="clearAllData()" class="danger">全データ削除</button>
        <button onclick="deleteDatabase()" class="danger">データベース完全削除</button>
        <button onclick="cleanExpiredData()">期限切れデータ削除</button>
        <div id="status" class="status"></div>
    </div>
    
    <div class="container">
        <h2>データ追加・更新</h2>
        <div class="form-group">
            <label>ID:</label>
            <input type="number" id="itemId" placeholder="更新時のみ指定">
        </div>
        <div class="form-group">
            <label>名前:</label>
            <input type="text" id="itemName" placeholder="名前を入力">
        </div>
        <div class="form-group">
            <label>年齢:</label>
            <input type="number" id="itemAge" placeholder="年齢を入力">
        </div>
        <div class="form-group">
            <label>職業:</label>
            <input type="text" id="itemJob" placeholder="職業を入力">
        </div>
        <div class="form-group">
            <label>有効期限:</label>
            <select id="itemTTL">
                <option value="">無期限</option>
                <option value="60000">1分</option>
                <option value="300000">5分</option>
                <option value="900000">15分</option>
                <option value="3600000">1時間</option>
                <option value="86400000">1日</option>
            </select>
        </div>
        <button onclick="addOrUpdateData()">追加・更新</button>
    </div>
    
    <div class="container">
        <h2>データ検索</h2>
        <div class="form-group">
            <label>検索:</label>
            <input type="text" id="searchTerm" placeholder="名前で検索">
            <button onclick="searchData()">検索</button>
            <button onclick="loadAllData()">全件表示</button>
        </div>
    </div>
    
    <div class="container">
        <h2>データ一覧</h2>
        <div id="dataList"></div>
    </div>
    
    <script>
        let db;
        const DB_NAME = 'SampleDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'people';

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${isError ? 'error' : 'success'}`;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'status';
            }, 3000);
        }

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = function(event) {
                console.error('データベースエラー:', event.target.error);
                showStatus('データベースの初期化に失敗しました', true);
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('データベース初期化完了');
                showStatus('データベースが正常に初期化されました');
                loadAllData();
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('name', 'name', { unique: false });
                    objectStore.createIndex('age', 'age', { unique: false });
                    objectStore.createIndex('job', 'job', { unique: false });
                    objectStore.createIndex('expiresAt', 'expiresAt', { unique: false });
                }
            };
        }

        function generateSampleData() {
            if (!db) {
                showStatus('先にデータベースを初期化してください', true);
                return;
            }

            const now = Date.now();
            const sampleData = [
                { name: '田中太郎', age: 30, job: 'エンジニア', createdAt: now },
                { name: '佐藤花子', age: 25, job: 'デザイナー', createdAt: now },
                { name: '鈴木一郎', age: 35, job: 'マネージャー', createdAt: now, expiresAt: now + 300000 },
                { name: '高橋美咲', age: 28, job: 'マーケター', createdAt: now },
                { name: '伊藤健太', age: 32, job: 'プロダクトオーナー', createdAt: now, expiresAt: now + 900000 }
            ];

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);

            sampleData.forEach(data => {
                objectStore.add(data);
            });

            transaction.oncomplete = function() {
                showStatus('サンプルデータを生成しました');
                loadAllData();
            };

            transaction.onerror = function(event) {
                console.error('データ追加エラー:', event.target.error);
                showStatus('サンプルデータの生成に失敗しました', true);
            };
        }

        function addOrUpdateData() {
            if (!db) {
                showStatus('先にデータベースを初期化してください', true);
                return;
            }

            const id = document.getElementById('itemId').value;
            const name = document.getElementById('itemName').value;
            const age = parseInt(document.getElementById('itemAge').value);
            const job = document.getElementById('itemJob').value;
            const ttl = document.getElementById('itemTTL').value;

            if (!name || !age || !job) {
                showStatus('すべての項目を入力してください', true);
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);

            const now = Date.now();
            const data = { name, age, job, createdAt: now };
            if (ttl) {
                data.expiresAt = now + parseInt(ttl);
            }
            if (id) {
                data.id = parseInt(id);
                objectStore.put(data);
            } else {
                objectStore.add(data);
            }

            transaction.oncomplete = function() {
                showStatus(id ? 'データを更新しました' : 'データを追加しました');
                clearForm();
                loadAllData();
            };

            transaction.onerror = function(event) {
                console.error('データ操作エラー:', event.target.error);
                showStatus('データの操作に失敗しました', true);
            };
        }

        function searchData() {
            if (!db) {
                showStatus('先にデータベースを初期化してください', true);
                return;
            }

            const searchTerm = document.getElementById('searchTerm').value.toLowerCase();
            if (!searchTerm) {
                loadAllData();
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.getAll();

            request.onsuccess = function(event) {
                const allData = event.target.result;
                const filteredData = allData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
                displayData(filteredData);
            };
        }

        function loadAllData() {
            if (!db) {
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.getAll();

            request.onsuccess = function(event) {
                const data = event.target.result;
                const now = Date.now();
                const validData = data.filter(item => !item.expiresAt || item.expiresAt > now);
                displayData(validData);
            };
        }

        function displayData(data) {
            const dataList = document.getElementById('dataList');
            
            if (data.length === 0) {
                dataList.innerHTML = '<p>データがありません</p>';
                return;
            }

            const now = Date.now();
            dataList.innerHTML = data.map(item => {
                const createdDate = new Date(item.createdAt).toLocaleString('ja-JP');
                let expiryInfo = '';
                if (item.expiresAt) {
                    const expiryDate = new Date(item.expiresAt).toLocaleString('ja-JP');
                    const isExpired = item.expiresAt <= now;
                    expiryInfo = `<br><strong>期限:</strong> <span style="color: ${isExpired ? 'red' : 'orange'}">${expiryDate}${isExpired ? ' (期限切れ)' : ''}</span>`;
                }
                return `
                    <div class="data-item">
                        <strong>ID:</strong> ${item.id}<br>
                        <strong>名前:</strong> ${item.name}<br>
                        <strong>年齢:</strong> ${item.age}<br>
                        <strong>職業:</strong> ${item.job}<br>
                        <strong>作成日時:</strong> ${createdDate}${expiryInfo}<br>
                        <button onclick="editData(${item.id}, '${item.name}', ${item.age}, '${item.job}')">編集</button>
                        <button onclick="deleteData(${item.id})" class="danger">削除</button>
                    </div>
                `;
            }).join('');
        }

        function editData(id, name, age, job) {
            document.getElementById('itemId').value = id;
            document.getElementById('itemName').value = name;
            document.getElementById('itemAge').value = age;
            document.getElementById('itemJob').value = job;
        }

        function deleteData(id) {
            if (!db) {
                showStatus('先にデータベースを初期化してください', true);
                return;
            }

            if (!confirm('このデータを削除しますか？')) {
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.delete(id);

            request.onsuccess = function() {
                showStatus('データを削除しました');
                loadAllData();
            };

            request.onerror = function(event) {
                console.error('削除エラー:', event.target.error);
                showStatus('データの削除に失敗しました', true);
            };
        }

        function clearAllData() {
            if (!db) {
                showStatus('先にデータベースを初期化してください', true);
                return;
            }

            if (!confirm('すべてのデータを削除しますか？この操作は取り消せません。')) {
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const request = objectStore.clear();

            request.onsuccess = function() {
                showStatus('すべてのデータを削除しました');
                loadAllData();
            };

            request.onerror = function(event) {
                console.error('全削除エラー:', event.target.error);
                showStatus('データの削除に失敗しました', true);
            };
        }

        function deleteDatabase() {
            if (!confirm('データベース全体を完全に削除しますか？この操作は取り消せません。')) {
                return;
            }

            if (db) {
                db.close();
            }

            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            
            deleteRequest.onsuccess = function() {
                db = null;
                showStatus('データベースを完全に削除しました');
                document.getElementById('dataList').innerHTML = '<p>データがありません</p>';
            };
            
            deleteRequest.onerror = function(event) {
                console.error('データベース削除エラー:', event.target.error);
                showStatus('データベースの削除に失敗しました', true);
            };
        }

        function cleanExpiredData() {
            if (!db) {
                showStatus('先にデータベースを初期化してください', true);
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(STORE_NAME);
            const index = objectStore.index('expiresAt');
            const now = Date.now();
            
            const range = IDBKeyRange.upperBound(now);
            const request = index.openCursor(range);
            let deletedCount = 0;

            request.onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor) {
                    cursor.delete();
                    deletedCount++;
                    cursor.continue();
                }
            };

            transaction.oncomplete = function() {
                showStatus(`期限切れデータ ${deletedCount} 件を削除しました`);
                loadAllData();
            };

            transaction.onerror = function(event) {
                console.error('期限切れデータ削除エラー:', event.target.error);
                showStatus('期限切れデータの削除に失敗しました', true);
            };
        }

        function clearForm() {
            document.getElementById('itemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemAge').value = '';
            document.getElementById('itemJob').value = '';
            document.getElementById('itemTTL').value = '';
        }

        setInterval(function() {
            if (db) {
                loadAllData();
            }
        }, 30000);

        window.addEventListener('load', function() {
            initDB();
        });
    </script>
</body>
</html>